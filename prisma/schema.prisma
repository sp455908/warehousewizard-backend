generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String                @id @default(uuid())
  email            String                @unique
  passwordHash     String
  firstName        String
  lastName         String
  mobile           String?
  company          String?
  role             UserRole              @default(customer)
  isActive         Boolean               @default(true)
  isEmailVerified  Boolean               @default(false)
  isMobileVerified Boolean               @default(false)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  bookingsApproved Booking[]             @relation("BookingApprovedBy")
  bookings         Booking[]             @relation("UserBookings")
  cargoApproved    CargoDispatchDetail[] @relation("CargoApprovedBy")
  deliveryAdvices  DeliveryAdvice[]      @relation("DeliveryAdviceCustomer")
  deliveryOrders   DeliveryOrder[]       @relation("DeliveryOrderCustomer")
  deliveryReports  DeliveryReport[]      @relation("DeliveryReportCustomer")
  deliveryRequests DeliveryRequest[]     @relation("DeliveryCustomer")
  formSubmissions  FormSubmission[]      @relation("FormCustomer")
  invoices         Invoice[]             @relation("InvoiceCustomer")
  otpVerifications OtpVerification[]     @relation("UserOtp")
  assignedQuotes   Quote[]               @relation("AssignedQuotes")
  quotes           Quote[]               @relation("UserQuotes")
  ownedWarehouses  Warehouse[]           @relation("WarehouseOwner")
  sessions         Session[]
}

model OtpVerification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  code      String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation("UserOtp", fields: [userId], references: [id], onDelete: Cascade)
}

model Warehouse {
  id              String           @id @default(uuid())
  name            String
  location        String
  city            String
  state           String
  storageType     StorageType
  totalSpace      Int
  availableSpace  Int
  pricePerSqFt    Float
  features        Json?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  imageUrl        String?
  ownerId         String?
  bookings        Booking[]
  cartingDetails  CartingDetail[]
  deliveryOrders  DeliveryOrder[]
  deliveryReports DeliveryReport[]
  formSubmissions FormSubmission[] @relation("FormWarehouse")
  quotes          Quote[]
  rfqs            RFQ[]
  rates           Rate[]
  owner           User?            @relation("WarehouseOwner", fields: [ownerId], references: [id], onDelete: Cascade)
}

model Quote {
  id                  String           @id @default(uuid())
  customerId          String
  storageType         String
  requiredSpace       Int
  preferredLocation   String
  duration            String
  specialRequirements String?
  status              QuoteStatus      @default(pending)
  assignedTo          String?
  finalPrice          Float?
  warehouseId         String?
  currentWorkflowStep String?
  flowType            String?
  workflowHistory     Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  bookings            Booking[]
  formSubmissions     FormSubmission[] @relation("FormQuote")
  assignedToUser      User?            @relation("AssignedQuotes", fields: [assignedTo], references: [id])
  customer            User             @relation("UserQuotes", fields: [customerId], references: [id], onDelete: Cascade)
  warehouse           Warehouse?       @relation(fields: [warehouseId], references: [id])
  rfqs                RFQ[]
}

model Booking {
  id              String                @id @default(uuid())
  quoteId         String
  customerId      String
  warehouseId     String
  status          BookingStatus         @default(pending)
  startDate       DateTime
  endDate         DateTime
  totalAmount     Float
  approvedById    String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  approvedBy      User?                 @relation("BookingApprovedBy", fields: [approvedById], references: [id])
  customer        User                  @relation("UserBookings", fields: [customerId], references: [id], onDelete: Cascade)
  quote           Quote                 @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  warehouse       Warehouse             @relation(fields: [warehouseId], references: [id])
  cargoItems      CargoDispatchDetail[]
  cartingDetails  CartingDetail[]
  deliveryAdvices DeliveryAdvice[]
  deliveryOrders  DeliveryOrder[]
  deliveryReports DeliveryReport[]
  deliveries      DeliveryRequest[]
  invoices        Invoice[]
}

model CargoDispatchDetail {
  id              String      @id @default(uuid())
  bookingId       String
  itemDescription String
  quantity        Int
  weight          Float?
  dimensions      String?
  specialHandling String?
  status          CargoStatus @default(submitted)
  approvedById    String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  approvedBy      User?       @relation("CargoApprovedBy", fields: [approvedById], references: [id])
  booking         Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model DeliveryRequest {
  id              String          @id @default(uuid())
  bookingId       String
  customerId      String
  deliveryAddress String
  preferredDate   DateTime
  urgency         DeliveryUrgency @default(standard)
  status          DeliveryStatus  @default(requested)
  assignedDriver  String?
  trackingNumber  String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  booking         Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer        User            @relation("DeliveryCustomer", fields: [customerId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String        @id @default(uuid())
  bookingId     String
  customerId    String
  invoiceNumber String        @unique
  amount        Float
  status        InvoiceStatus @default(draft)
  dueDate       DateTime
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer      User          @relation("InvoiceCustomer", fields: [customerId], references: [id], onDelete: Cascade)
}

model FormSubmission {
  id          String     @id @default(uuid())
  customerId  String?
  warehouseId String?
  quoteId     String?
  type        FormType
  data        Json
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customer    User?      @relation("FormCustomer", fields: [customerId], references: [id])
  quote       Quote?     @relation("FormQuote", fields: [quoteId], references: [id])
  warehouse   Warehouse? @relation("FormWarehouse", fields: [warehouseId], references: [id])
}

model WorkflowEvent {
  id             String   @id @default(uuid())
  entityType     String
  entityId       String
  fromStage      String?
  toStage        String
  action         String
  routedToRole   String?
  routedToUserId String?
  actorUserId    String?
  payload        Json?
  createdAt      DateTime @default(now())
}

model Session {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  userAgent String?
  ipAddress String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  lastSeen  DateTime  @default(now())
  expiresAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model RFQ {
  id          String    @id @default(uuid())
  quoteId     String
  warehouseId String
  status      RFQStatus @default(sent)
  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  validUntil  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  rates       Rate[]

  @@index([quoteId])
  @@index([status])
  @@index([warehouseId])
}

model Rate {
  id                 String     @id @default(uuid())
  rfqId              String
  warehouseId        String
  rate               Float
  termsAndConditions String?
  remark             String?
  status             RateStatus @default(pending)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  rfq                RFQ        @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  warehouse          Warehouse  @relation(fields: [warehouseId], references: [id])

  @@index([rfqId])
  @@index([status])
  @@index([warehouseId])
}

model CartingDetail {
  id              String        @id @default(uuid())
  bookingId       String
  warehouseId     String
  itemDescription String
  quantity        Int
  weight          Float?
  dimensions      String?
  specialHandling String?
  status          CartingStatus @default(submitted)
  submittedAt     DateTime      @default(now())
  confirmedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])

  @@index([bookingId])
  @@index([status])
  @@index([warehouseId])
}

model DeliveryAdvice {
  id                String               @id @default(uuid())
  bookingId         String
  customerId        String
  deliveryAddress   String
  preferredDate     DateTime
  urgency           DeliveryUrgency      @default(standard)
  instructions      String?
  bookingNumber     String?
  availableQuantity Int?
  requiredQuantity  Float?
  billingParty      String?
  remarks           String?
  status            DeliveryAdviceStatus @default(created)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  booking           Booking              @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer          User                 @relation("DeliveryAdviceCustomer", fields: [customerId], references: [id])
  deliveryOrders    DeliveryOrder[]

  @@index([bookingId])
  @@index([customerId])
  @@index([status])
}

model DeliveryOrder {
  id               String              @id @default(uuid())
  deliveryAdviceId String
  bookingId        String
  customerId       String
  warehouseId      String
  orderNumber      String              @unique
  status           DeliveryOrderStatus @default(created)
  issuedAt         DateTime            @default(now())
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  booking          Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer         User                @relation("DeliveryOrderCustomer", fields: [customerId], references: [id])
  deliveryAdvice   DeliveryAdvice      @relation(fields: [deliveryAdviceId], references: [id], onDelete: Cascade)
  warehouse        Warehouse           @relation(fields: [warehouseId], references: [id])
  deliveryReports  DeliveryReport[]

  @@index([bookingId])
  @@index([customerId])
  @@index([deliveryAdviceId])
  @@index([status])
  @@index([warehouseId])
}

model DeliveryReport {
  id                  String               @id @default(uuid())
  deliveryOrderId     String
  bookingId           String
  customerId          String
  warehouseId         String
  reportNumber        String               @unique
  deliveredAt         DateTime
  pod                 String?
  grn                 String?
  quantities          Int?
  exceptions          String?
  quantityDispatched  String?
  vehicleNumber       String?
  driverContactNumber String?
  dispatchDate        DateTime?
  status              DeliveryReportStatus @default(created)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  booking             Booking              @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer            User                 @relation("DeliveryReportCustomer", fields: [customerId], references: [id])
  deliveryOrder       DeliveryOrder        @relation(fields: [deliveryOrderId], references: [id], onDelete: Cascade)
  warehouse           Warehouse            @relation(fields: [warehouseId], references: [id])

  @@index([bookingId])
  @@index([customerId])
  @@index([deliveryOrderId])
  @@index([status])
  @@index([warehouseId])
}

enum UserRole {
  customer
  purchase_support
  sales_support
  supervisor
  warehouse
  accounts
  admin
}

enum StorageType {
  domestic_dry
  domestic_reefer
  bonded_dry
  bonded_reefer
  cfs_import
  cfs_export_dry
  cfs_export_reefer
}

enum QuoteStatus {
  pending
  processing
  quoted
  approved
  rejected
  warehouse_quote_requested
  warehouse_quote_received
  rate_confirmed
  supervisor_review_pending
  customer_confirmation_pending
  customer_confirmed
  booking_confirmed
}

enum BookingStatus {
  pending
  confirmed
  active
  completed
  cancelled
  customer_confirmation_pending
  supervisor_confirmation_pending
}

enum CargoStatus {
  submitted
  approved
  processing
  completed
  cdd_confirmed
  carting_details_submitted
}

enum DeliveryStatus {
  requested
  scheduled
  in_transit
  delivered
  delivery_advice_created
  delivery_order_created
  delivery_report_created
}

enum DeliveryUrgency {
  standard
  express
  urgent
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

enum FormType {
  domestic_dry
  domestic_reefer
  bonded_dry
  bonded_reefer
  cfs_import
  cfs_export_dry
  cfs_export_reefer
}

enum RFQStatus {
  sent
  responded
  expired
  cancelled
}

enum RateStatus {
  pending
  accepted
  rejected
  expired
}

enum CartingStatus {
  submitted
  confirmed
  rejected
}

enum DeliveryAdviceStatus {
  created
  sent
  acknowledged
}

enum DeliveryOrderStatus {
  created
  sent
  acknowledged
  executed
}

enum DeliveryReportStatus {
  created
  sent
  acknowledged
}
